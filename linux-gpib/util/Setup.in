#!/bin/bash

CONFIG=.tmpconfig
CONFIG_H=.tmpconfig.h

trap "rm -f $CONFIG $CONFIG_H $CONFIG_NEW ; exit 1" 1 2

set -e

#
# Make sure we start out with a clean slate.
#

echo "#" > $CONFIG
echo "# Automatically generated make config: don't edit" >> $CONFIG
echo "#" >> $CONFIG

echo "/*" > $CONFIG_H
echo " * Automatically generated C config: don't edit" >> $CONFIG_H
echo " */" >> $CONFIG_H

DEFAULT=$1

set_svar DIALOG $DIALOG

##########
#
# initial message
#
##########


$DIALOG --clear --title "Linux-GPIB Configuration" --msgbox "\
\n\
Welcome to the Linux-GPIB configuration program\n\
\n\
 (c) 1995-1999 by C.Schroeter (clausi@chemie.fu-berlin.de)\n\
 (c) 2001,2002 by Frank Mori Hess (fmhess@users.sourceforge.net)\n\
" 10 70


##########
#
# kernel source directory
#
##########

#load old setting for LINUXDIR if available
LINUXDIR="/usr/src/linux"
if [ -f ".config" ];then
	source .config
fi

RESULT=$($DIALOG --title "Kernel Source Directory" --inputbox "Input path to linux \
kernel source directory" 10 70 $LINUXDIR 2>&1 1>/dev/tty)

set_svar LINUXDIR $RESULT

#test linuxdir to make sure it is properly configured.
if [ ! -d "$LINUXDIR" ];then
	echo
	echo directory $LINUXDIR does not exist
	echo Fix before continuing
	echo
	exit 1
fi

if [ ! -f "$LINUXDIR/.config" ];then
	echo
	echo Kernel source tree at $LINUXDIR is not configured
	echo Fix before continuing
	echo
	exit 1
fi

if [ ! -f "$LINUXDIR/.hdepend" ];then
	echo
	echo You need to run \'make dep\' on the kernel source before
	echo continuing.
	echo
	exit 1
fi


##########
#
# board selection
#
##########

RESULT=$($DIALOG --title "Board Type Selection" \
--checklist "Select desired drivers" \
	17 76 10 \
	"PC2"  "National Instruments PCII, PCIIa, and compatible" "on" \
	"TNT4882" "National Instruments boards with tnt4882 chip" "on" \
	"CB7210" "Measurement Computing (Computer Boards) boards" "on" \
	"INES" "Ines boards" "on" \
	"CEC" "Captial Equipment Corporation / Keithley" "on" \
	"TNT4882TMS" "NI PCI-GPIB in tms9914 mode (for testing only)" "off" \
	2>&1 1>/dev/tty)

if [ $? = 0 ]; then
	for i in `echo $RESULT | sed 's!\"!!g' `; do
		set_var $i 1
	done
fi

##########
#
# extra options
#
##########

RESULT=$($DIALOG --title "Compilation options" \
--checklist "Select compilation options" \
	17 76 10 \
	"GPIB_CONFIG_PCMCIA"  "Compile in support for PCMCIA boards" "off" \
	"GPIB_CONFIG_VERBOSE_DEBUG" "Produce verbose debugging messages" "off" \
	2>&1 1>/dev/tty)

if [ $? = 0 ]; then
	for i in `echo $RESULT | sed 's!\"!!g' `; do
		set_var $i 1
	done
fi

##########
#
# doing some final setups
#
##########

set_var IBMAJOR 160

##########
#
# generating additional Files
#
##########

# get compile flags for modules from linux kernel source tree
export LINUXDIR=$LINUXDIR
(cd ./linux_flags && make)

if [ $? != 0 ]; then
	exit 1
fi

mv .tmpconfig .config
mv .tmpconfig.h ../include/autoconf.h



######################################################################

$DIALOG --msgbox "
\n\
            Configuration Finished ! \n\
\n\
      Now Type 'make' to start compilation\n" 10 60





######################################################################

